#!/bin/sh

/etc/uci-defaults/luci-passwall

uci set luci.main.lang=zh_cn
uci commit luci

uci set system.@system[0].timezone=CST-8
uci set system.@system[0].zonename=Asia/Shanghai
uci commit system

uci set fstab.@global[0].anon_mount=1
uci commit fstab

rm -f /usr/lib/lua/luci/view/admin_status/index/mwan.htm
rm -f /usr/lib/lua/luci/view/admin_status/index/upnp.htm
rm -f /usr/lib/lua/luci/view/admin_status/index/ddns.htm
rm -f /usr/lib/lua/luci/view/admin_status/index/minidlna.htm

sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/aria2.lua
sed -i 's/services/nas/g' /usr/lib/lua/luci/view/aria2/overview_status.htm
sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/hd_idle.lua
sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/samba.lua
sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/samba4.lua
sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/minidlna.lua
sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/transmission.lua
sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/mjpg-streamer.lua
sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/p910nd.lua
sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/usb_printer.lua
sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/xunlei.lua
sed -i 's/services/nas/g'  /usr/lib/lua/luci/view/minidlna_status.htm

ln -sf /sbin/ip /usr/bin/ip

sed -i 's#downloads.openwrt.org#mirrors.cloud.tencent.com/lede#g' /etc/opkg/distfeeds.conf
sed -i 's/root::0:0:99999:7:::/root:$1$pl544Ip9$eVk3sgSxTPNYWwV5cI4wU.:19326:0:99999:7:::/g' /etc/shadow
sed -i 's/root:::0:99999:7:::/root:$1$pl544Ip9$eVk3sgSxTPNYWwV5cI4wU.:19326:0:99999:7:::/g' /etc/shadow

sed -i "s/# //g" /etc/opkg/distfeeds.conf
sed -i '/openwrt_luci/ { s/snapshots/releases\/18.06.9/g; }'  /etc/opkg/distfeeds.conf

sed -i '/REDIRECT --to-ports 53/d' /etc/firewall.user
echo 'iptables -t nat -A PREROUTING -p udp --dport 53 -j REDIRECT --to-ports 53' >> /etc/firewall.user
echo 'iptables -t nat -A PREROUTING -p tcp --dport 53 -j REDIRECT --to-ports 53' >> /etc/firewall.user

echo '[ -n "$(command -v ip6tables)" ] && ip6tables -t nat -A PREROUTING -p udp --dport 53 -j REDIRECT --to-ports 53' >> /etc/firewall.user
echo '[ -n "$(command -v ip6tables)" ] && ip6tables -t nat -A PREROUTING -p tcp --dport 53 -j REDIRECT --to-ports 53' >> /etc/firewall.user

#echo 'iptables -A OUTPUT -m string --string "api.installer.xiaomi.cn" --algo bm --to 65535 -j DROP' >> /etc/firewall.user

sed -i '/option disabled/d' /etc/config/wireless
sed -i '/set wireless.radio${devidx}.disabled/d' /lib/wifi/mac80211.sh

sed -i '/DISTRIB_REVISION/d' /etc/openwrt_release
echo "DISTRIB_REVISION='R23.6.6'" >> /etc/openwrt_release
sed -i '/DISTRIB_DESCRIPTION/d' /etc/openwrt_release
echo "DISTRIB_DESCRIPTION='OpenWrt '" >> /etc/openwrt_release

sed -i '/log-facility/d' /etc/dnsmasq.conf
echo "log-facility=/dev/null" >> /etc/dnsmasq.conf

rm -rf /tmp/luci-modulecache/
rm -f /tmp/luci-indexcache

uci set network.lan.ipaddr='192.168.0.1'   # 默认 IP 地址
uci set network.lan.proto='static'   # 静态 IP
uci set network.lan.type='bridge'   # 接口类型：桥接
uci set network.lan.ifname='eth1'   # 网络端口：默认 eth0，第一个接口
uci set network.lan.netmask='255.255.255.0' # 子网掩码
uci set network.lan.gateway='192.168.0.1'   # 默认网关地址（主路由 IP）
uci set network.lan.dns='192.168.0.1'  # 默认上游 DNS 地址
uci set network.lan.ip6assign='60'
uci commit network

uci set dhcp.@dnsmasq[0].dnsforwardmax='10000'
uci set dhcp.@dnsmasq[0].cachesize='0'
uci set dhcp.@dnsmasq[0].mini_ttl='0'
uci set dhcp.@dnsmasq[0].rebind_protection='0'
uci set dhcp.@dnsmasq[0].noresolv='1'
uci set dhcp.@dnsmasq[0].nohosts='1'
uci set dhcp.@dnsmasq[0].nonegcache='1'
uci set dhcp.@dnsmasq[0].boguspriv='0'
uci set dhcp.@dnsmasq[0].domain='c2201.home'
uci set dhcp.@dnsmasq[0].server='127.0.0.1#5334'
uci set dhcp.@dnsmasq[0].filter_aaaa='0'
uci set dhcp.lan.start='50'
uci set dhcp.lan.limit='150'
uci add dhcp host
uci set dhcp.@host[0].name='Linksys00061'
uci set dhcp.@host[0].dns='1'
uci set dhcp.@host[0].mac='e8:9f:80:d7:77:d0'
uci set dhcp.@host[0].ip='192.168.0.4'
uci add dhcp host
uci set dhcp.@host[1].name='Linksys02189'
uci set dhcp.@host[1].dns='1'
uci set dhcp.@host[1].mac='e8:9f:80:53:e7:0c'
uci set dhcp.@host[1].ip='192.168.0.5'
uci add dhcp host
uci set dhcp.@host[2].name='Linksys02215'
uci set dhcp.@host[2].dns='1'
uci set dhcp.@host[2].mac='e8:9f:80:53:e7:8e'
uci set dhcp.@host[2].ip='192.168.0.6'
uci add dhcp host
uci set dhcp.@host[3].name='Linksys02207'
uci set dhcp.@host[3].dns='1'
uci set dhcp.@host[3].mac='e8:9f:80:53:e7:66'
uci set dhcp.@host[3].ip='192.168.0.7'
uci add dhcp host
uci set dhcp.@host[4].name='Linksys05853'
uci set dhcp.@host[4].dns='1'
uci set dhcp.@host[4].mac='e8:9f:80:c8:d4:50'
uci set dhcp.@host[4].ip='192.168.0.8'
uci add dhcp host
uci set dhcp.@host[5].name='Linksys06342'
uci set dhcp.@host[5].dns='1'
uci set dhcp.@host[5].mac='e8:9f:80:c8:dd:dd'
uci set dhcp.@host[5].ip='192.168.0.9'
uci add dhcp host
uci set dhcp.@host[6].name='iPhone12pro'
uci set dhcp.@host[6].dns='1'
uci set dhcp.@host[6].mac='b2:36:d5:c3:e3:fd'
uci set dhcp.@host[6].ip='192.168.0.21'
uci add dhcp host
uci set dhcp.@host[7].name='DESKTOP-F7UK3L1'
uci set dhcp.@host[7].dns='1'
uci set dhcp.@host[7].mac='d8:bb:c1:99:1b:b1'
uci set dhcp.@host[7].ip='192.168.0.22'
uci add dhcp host
uci set dhcp.@host[8].name='unraid-gen8'
uci set dhcp.@host[8].dns='1'
uci set dhcp.@host[8].mac='00:fd:45:fc:8b:3c'
uci set dhcp.@host[8].ip='192.168.0.11'
uci add dhcp host
uci set dhcp.@host[9].name='DESKTOP-Gen8'
uci set dhcp.@host[9].dns='1'
uci set dhcp.@host[9].mac='a0:36:9f:49:65:ab'
uci set dhcp.@host[9].ip='192.168.0.14'
uci commit dhcp
uci add dhcp host
uci set dhcp.@host[-1].name='ILO-GEN8'
uci set dhcp.@host[-1].dns='1'
uci set dhcp.@host[-1].ip='192.168.0.10'
uci set dhcp.@host[-1].mac='00:fd:45:fc:8b:3e'
uci commit dhcp
uci add dhcp host
uci set dhcp.@host[-1].name='youxishiatv4k'
uci set dhcp.@host[-1].dns='1'
uci set dhcp.@host[-1].ip='192.168.0.23'
uci set dhcp.@host[-1].mac='f0:b3:ec:09:b3:8e'
uci commit dhcp
uci add dhcp host
uci set dhcp.@host[-1].name='mac-m2-eth'
uci set dhcp.@host[-1].dns='1'
uci set dhcp.@host[-1].mac='58:ef:68:e7:42:21'
uci set dhcp.@host[-1].ip='192.168.0.24'
uci commit dhcp
uci add dhcp host
uci set dhcp.@host[-1].name='mac-m2-wifi'
uci set dhcp.@host[-1].dns='1'
uci set dhcp.@host[-1].mac='a4:cf:99:51:ce:13'
uci set dhcp.@host[-1].ip='192.168.0.25'
uci commit dhcp

echo 'server=127.0.0.1#5334' >> /etc/dnsmasq.conf

uci set mosdns.config=mosdns
uci set mosdns.config.enabled_api='1'
uci set mosdns.config.redirect='0'
uci set mosdns.config.enabled='1'
uci set mosdns.config.configfile='/etc/mosdns/config_custom.yaml'
uci commit mosdns
uci set mosdns.config.geoip_tags='cn'
uci add_list mosdns.config.geosite_tags='cn'
uci add_list mosdns.config.geosite_tags='ookla-speedtest'
uci add_list mosdns.config.geosite_tags='apple-cn'
uci add_list mosdns.config.geosite_tags='google-cn'
uci add_list mosdns.config.geosite_tags='playstation'
uci add_list mosdns.config.geosite_tags='bing'
uci add_list mosdns.config.geosite_tags='private'
uci add_list mosdns.config.geosite_tags='category-games@cn'
uci add_list mosdns.config.geosite_tags='icloud'
uci add_list mosdns.config.geosite_tags='sony@cn'
uci add_list mosdns.config.geosite_tags='jetbrains'
uci add_list mosdns.config.geosite_tags='microsoft'
uci add_list mosdns.config.geosite_tags='tld-cn'
uci add_list mosdns.config.geosite_tags='geolocation-cn'
uci add_list mosdns.config.geosite_tags='onedrive'
uci add_list mosdns.config.geosite_tags='xbox'
uci add_list mosdns.config.geosite_tags='geolocation-!cn'
uci add_list mosdns.config.geosite_tags='gfw'
uci add_list mosdns.config.geosite_tags='greatfire'
uci add_list mosdns.config.geosite_tags='category-ads-all'
uci add_list mosdns.config.geosite_tags='test-ipv6'
uci set mosdns.config.geo_auto_update='0'
uci commit mosdns

uci set unbound.ub_main.enabled='1'
uci set unbound.ub_main.manual_conf='1'
uci set unbound.ub_main.extended_luci='1'
uci set unbound.ub_main.listen_port='5334'
uci commit unbound

uci set network.wan.proto='pppoe'
uci set network.wan.username='pppoe-wan-username'
uci set network.wan.password='pppoe-wan-password'
uci set network.wan.mtu='1492'
uci set network.globals.ula_prefix=''
uci set network.wan.peerdns='0'
uci set network.wan6.peerdns='0'
uci set network.wan6.mtu='1472'
uci commit network

uci set ddns.global=ddns
uci set ddns.global.ddns_dateformat='%F %R'
uci set ddns.global.ddns_loglines='250'
uci set ddns.global.upd_privateip='0'
uci set ddns.home=service
uci set ddns.home.service_name='dnspod.cn'
uci set ddns.home.enabled='1'
uci set ddns.home.lookup_host='home.caijinbiao.cn'
uci set ddns.home.domain='home.caijinbiao.cn'
uci set ddns.home.username='tencent-cloud-id'
uci set ddns.home.password='tencent-cloud-token'
uci set ddns.Home6=service
uci set ddns.Home6.service_name='dnspod.cn'
uci set ddns.Home6.enabled='1'
uci set ddns.Home6.lookup_host='home6.caijinbiao.cn'
uci set ddns.Home6.use_ipv6='1'
uci set ddns.Home6.domain='home6.caijinbiao.cn'
uci set ddns.Home6.username='tencent-cloud-id'
uci set ddns.Home6.password='tencent-cloud-token'
uci set ddns.Home6.ip_source='web'
uci set ddns.alist=service
uci set ddns.alist.service_name='dnspod.cn'
uci set ddns.alist.enabled='1'
uci set ddns.alist.lookup_host='alist.c2201.top'
uci set ddns.alist.use_ipv6='1'
uci set ddns.alist.domain='alist.c2201.top'
uci set ddns.alist.username='tencent-cloud-id'
uci set ddns.alist.password='tencent-cloud-token'
uci set ddns.alist.ip_source='web'
uci commit ddns

uci set sqm.eth1.enabled='1'
uci set sqm.eth1.download='856625'
uci set sqm.eth1.upload='48000'
uci set sqm.eth1.interface='eth0'
uci commit sqm

uci set uuplugin.uuplugin.enabled='1'
uci commit uuplugin

uci delete passwall.STEAM
uci delete passwall.AD
uci delete passwall.Direct
uci delete passwall.Netflix
uci delete passwall.Proxy
uci commit passwall

uci_passwall

mv /usr/share/xray/geoip.dat /usr/share/v2ray/geoip.dat
mv /usr/share/xray/geosite.dat /usr/share/v2ray/geosite.dat
rm -rf /usr/share/xray

sed -i "s/fastpath\"/fastpath >\/dev\/null\"/g" /usr/lib/lua/luci/controller/turboacc.lua

uci set network.wireguard=interface
uci set network.wireguard.proto='wireguard'
uci set network.wireguard.private_key='server_privatekey'
uci set network.wireguard.listen_port='12345'
uci set network.wireguard.addresses='10.0.0.1/24'
uci add network wireguard_wireguard
uci set network.@wireguard_wireguard[0]=wireguard_wireguard
uci set network.@wireguard_wireguard[0]=wireguard_wireguard
uci set network.@wireguard_wireguard[0].route_allowed_ips='1'
uci set network.@wireguard_wireguard[0].persistent_keepalive='25'
uci set network.@wireguard_wireguard[0].public_key='store_publickey'
uci add_list network.@wireguard_wireguard[0].allowed_ips='10.0.0.2/32'
uci add_list network.@wireguard_wireguard[0].allowed_ips='192.168.2.0/24'
uci add network wireguard_wireguard
uci set network.@wireguard_wireguard[1]=wireguard_wireguard
uci set network.@wireguard_wireguard[1].public_key='iphone12_publickey'
uci set network.@wireguard_wireguard[1].route_allowed_ips='1'
uci set network.@wireguard_wireguard[1].persistent_keepalive='25'
uci set network.@wireguard_wireguard[1].allowed_ips='10.0.0.5/24'
uci add network route
uci set network.@route[0]=route
uci set network.@route[0].interface='wireguard'
uci set network.@route[0].target='192.168.2.0'
uci set network.@route[0].netmask='255.255.255.0'
uci set network.@route[0].gateway='10.0.0.2'
uci commit network
uci add firewall rule
uci set firewall.@rule[-1]=rule
uci set firewall.@rule[-1].target='ACCEPT'
uci set firewall.@rule[-1].src='wan'
uci set firewall.@rule[-1].proto='udp'
uci set firewall.@rule[-1].dest_port='12345'
uci set firewall.@rule[-1].name='Allow-Wireguard'
uci add firewall zone
uci set firewall.@zone[-1]=zone
uci set firewall.@zone[-1].input='ACCEPT'
uci set firewall.@zone[-1].output='ACCEPT'
uci set firewall.@zone[-1].forward='ACCEPT'
uci set firewall.@zone[-1].masq='1'
uci set firewall.@zone[-1].name='wireguard'
uci set firewall.@zone[-1].network='wireguard'
uci add firewall forwarding
uci set firewall.@forwarding[-1]=forwarding
uci set firewall.@forwarding[-1].dest='wireguard'
uci set firewall.@forwarding[-1].src='lan'
uci commit firewall
uci add firewall forwarding
uci set firewall.@forwarding[-1]=forwarding
uci set firewall.@forwarding[-1].dest='wan'
uci set firewall.@forwarding[-1].src='wireguard'
uci commit firewall
uci add firewall forwarding
uci set firewall.@forwarding[-1]=forwarding
uci set firewall.@forwarding[-1].dest='lan'
uci set firewall.@forwarding[-1].src='wireguard'
uci commit firewall
uci add firewall rule
uci set firewall.@rule[-1]=rule
uci set firewall.@rule[-1].target='ACCEPT'
uci set firewall.@rule[-1].src='wan'
uci set firewall.@rule[-1].proto='udp'
uci set firewall.@rule[-1].dest_port='456'
uci set firewall.@rule[-1].name='allow-ipv6-456'
uci set firewall.@rule[-1].family='ipv6'
uci commit firewall
uci add firewall rule
uci set firewall.@rule[-1]=rule
uci set firewall.@rule[-1].enabled='1'
uci set firewall.@rule[-1].target='ACCEPT'
uci set firewall.@rule[-1].src='wan'
uci set firewall.@rule[-1].name='allow-ipv6-igmp'
uci set firewall.@rule[-1].family='ipv6'
uci set firewall.@rule[-1].proto='igmp'
uci commit firewall
uci set turboacc.config.fullcone_nat='1'
uci commit turboacc

exit 0
