#!/bin/sh

/etc/uci-defaults/luci-passwall

uci set luci.main.lang=zh_cn
uci commit luci

uci set system.@system[0].timezone=CST-8
uci set system.@system[0].zonename=Asia/Shanghai
uci commit system

uci set fstab.@global[0].anon_mount=1
uci commit fstab

rm -f /usr/lib/lua/luci/view/admin_status/index/mwan.htm
rm -f /usr/lib/lua/luci/view/admin_status/index/upnp.htm
rm -f /usr/lib/lua/luci/view/admin_status/index/ddns.htm
rm -f /usr/lib/lua/luci/view/admin_status/index/minidlna.htm

sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/aria2.lua
sed -i 's/services/nas/g' /usr/lib/lua/luci/view/aria2/overview_status.htm
sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/hd_idle.lua
sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/samba.lua
sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/samba4.lua
sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/minidlna.lua
sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/transmission.lua
sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/mjpg-streamer.lua
sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/p910nd.lua
sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/usb_printer.lua
sed -i 's/\"services\"/\"nas\"/g' /usr/lib/lua/luci/controller/xunlei.lua
sed -i 's/services/nas/g'  /usr/lib/lua/luci/view/minidlna_status.htm

ln -sf /sbin/ip /usr/bin/ip

sed -i 's#downloads.openwrt.org#mirrors.cloud.tencent.com/lede#g' /etc/opkg/distfeeds.conf
sed -i 's/root::0:0:99999:7:::/root:$1$pl544Ip9$eVk3sgSxTPNYWwV5cI4wU.:19326:0:99999:7:::/g' /etc/shadow


sed -i "s/# //g" /etc/opkg/distfeeds.conf
sed -i '/openwrt_luci/ { s/snapshots/releases\/18.06.9/g; }'  /etc/opkg/distfeeds.conf

sed -i '/REDIRECT --to-ports 53/d' /etc/firewall.user
echo 'iptables -t nat -A PREROUTING -p udp --dport 53 -j REDIRECT --to-ports 53' >> /etc/firewall.user
echo 'iptables -t nat -A PREROUTING -p tcp --dport 53 -j REDIRECT --to-ports 53' >> /etc/firewall.user
echo '[ -n "$(command -v ip6tables)" ] && ip6tables -t nat -A PREROUTING -p udp --dport 53 -j REDIRECT --to-ports 53' >> /etc/firewall.user
echo '[ -n "$(command -v ip6tables)" ] && ip6tables -t nat -A PREROUTING -p tcp --dport 53 -j REDIRECT --to-ports 53' >> /etc/firewall.user

sed -i '/option disabled/d' /etc/config/wireless
sed -i '/set wireless.radio${devidx}.disabled/d' /lib/wifi/mac80211.sh

sed -i '/DISTRIB_REVISION/d' /etc/openwrt_release
echo "DISTRIB_REVISION='R22.12.1'" >> /etc/openwrt_release
sed -i '/DISTRIB_DESCRIPTION/d' /etc/openwrt_release
echo "DISTRIB_DESCRIPTION='OpenWrt '" >> /etc/openwrt_release

sed -i '/log-facility/d' /etc/dnsmasq.conf
echo "log-facility=/dev/null" >> /etc/dnsmasq.conf

rm -rf /tmp/luci-modulecache/
rm -f /tmp/luci-indexcache

uci set network.lan.ipaddr='192.168.2.1'   # 默认 IP 地址
uci set network.lan.proto='static'   # 静态 IP
uci set network.lan.type='bridge'   # 接口类型：桥接
uci set network.lan.ifname='eth1'   # 网络端口：默认 eth0，第一个接口
uci set network.lan.netmask='255.255.255.0' # 子网掩码
uci set network.lan.gateway='192.168.2.1'   # 默认网关地址（主路由 IP）
uci set network.lan.dns='192.168.2.1'  # 默认上游 DNS 地址
uci set network.lan.ip6assign='60'
uci commit network

uci set dhcp.@dnsmasq[0].dnsforwardmax='10000'
uci set dhcp.@dnsmasq[0].cachesize='0'
uci set dhcp.@dnsmasq[0].mini_ttl='0'
uci set dhcp.@dnsmasq[0].rebind_protection='0'
uci set dhcp.@dnsmasq[0].noresolv='1'
uci set dhcp.@dnsmasq[0].nohosts='1'
uci set dhcp.@dnsmasq[0].nonegcache='1'
uci set dhcp.@dnsmasq[0].boguspriv='0'
uci set dhcp.@dnsmasq[0].domain='c2201.store'
uci set dhcp.@dnsmasq[0].server='127.0.0.1#5334'
uci set dhcp.@dnsmasq[0].filter_aaaa='0'
uci set dhcp.lan.start='50'
uci set dhcp.lan.limit='150'
uci commit dhcp

echo 'server=127.0.0.1#5334' >> /etc/dnsmasq.conf

uci set mosdns.config.enabled='1'
uci set mosdns.config.configfile='/etc/mosdns/config_custom.yaml'
uci set mosdns.config.redirect='0'
uci commit mosdns

uci set network.wan.proto='pppoe'
uci set network.wan.username='store-pppoe-wan-username'
uci set network.wan.password='store-pppoe-wan-password'
uci set network.wan.mtu='1492'
uci set network.globals.ula_prefix=''
uci set network.wan.peerdns='0'
uci set network.wan6.peerdns='0'
uci commit network

uci set ddns.global=ddns
uci set ddns.global.ddns_dateformat='%F %R'
uci set ddns.global.ddns_loglines='250'
uci set ddns.global.upd_privateip='0'
uci set ddns.store=service
uci set ddns.store.service_name='dnspod.cn'
uci set ddns.store.enabled='1'
uci set ddns.store.lookup_host='store.caijinbiao.cn'
uci set ddns.store.domain='store.caijinbiao.cn'
uci set ddns.store.username='tencent-cloud-id'
uci set ddns.store.password='tencent-cloud-token'
uci set ddns.store6=service
uci set ddns.store6.service_name='dnspod.cn'
uci set ddns.store6.enabled='1'
uci set ddns.store6.lookup_host='store6.caijinbiao.cn'
uci set ddns.store6.use_ipv6='1'
uci set ddns.store6.domain='store6.caijinbiao.cn'
uci set ddns.store6.username='tencent-cloud-id'
uci set ddns.store6.password='tencent-cloud-token'
uci set ddns.store6.ip_source='web'
uci commit ddns

uci set sqm.eth1.enabled='1'
uci set sqm.eth1.download='495000'
uci set sqm.eth1.upload='48000'
uci set sqm.eth1.interface='eth0'
uci commit sqm

uci set unbound.ub_main.enabled='1'
uci set unbound.ub_main.manual_conf='1'
uci set unbound.ub_main.extended_luci='1'
uci set unbound.ub_main.listen_port='5334'
uci commit unbound

uci set passwall.@global[0]=global                                   
uci set passwall.@global[0].socks_enabled='0'                        
uci set passwall.@global[0].localhost_tcp_proxy_mode='default'       
uci set passwall.@global[0].localhost_udp_proxy_mode='default'       
uci set passwall.@global[0].close_log_tcp='0'                        
uci set passwall.@global[0].close_log_udp='0'                        
uci set passwall.@global[0].loglevel='error'                         
uci set passwall.@global[0].trojan_loglevel='4'                      
uci set passwall.@global[0].udp_node='tcp'                           
uci set passwall.@global[0].dns_mode='udp'                           
uci set passwall.@global[0].remote_dns='127.0.0.1:5334'              
uci set passwall.@global[0].enabled='1'                              
uci set passwall.@global[0].tcp_node='5aad9f34a17943de9badca96a5e37173'
uci set passwall.@global[0].tcp_proxy_mode='gfwlist'                 
uci set passwall.@global[0].udp_proxy_mode='gfwlist'                 
uci set passwall.@global_forwarding[0]=global_forwarding             
uci set passwall.@global_forwarding[0].tcp_proxy_way='tproxy'        
uci set passwall.@global_forwarding[0].ipv6_tproxy='1'               
uci set passwall.@global_rules[0]=global_rules                       
uci set passwall.@global_rules[0].chnlist_update='1'                 
uci set passwall.@global_rules[0].chnroute_update='1'                
uci set passwall.@global_rules[0].chnroute6_update='1'               
uci set passwall.@global_rules[0].gfwlist_update='1'                 
uci set passwall.@global_rules[0].gfwlist_url='https://fastly.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/gfw.txt'
uci set passwall.@global_rules[0].chnroute_url='https://ispip.clang.cn/all_cn.txt'
uci set passwall.@global_rules[0].chnroute6_url='https://ispip.clang.cn/all_cn_ipv6.txt'
uci set passwall.@global_rules[0].chnlist_url='https://fastly.jsdelivr.net/gh/felixonmars/dnsmasq-china-list/accelerated-domains.china.conf' 'https://fastly.jsdelivr.net/gh/felixonmars/dnsmasq-china-list/apple.china.conf' 'https://fastly.jsdelivr.net/gh/felixonmars/dnsmasq-china-list/google.china.conf'
uci set passwall.@global_rules[0].v2ray_location_asset='/usr/share/v2ray/'
uci set passwall.@global_rules[0].geosite_update='1'                 
uci set passwall.@global_rules[0].geoip_update='1'                   
uci set passwall.@global_rules[0].auto_update='1'                    
uci set passwall.@global_rules[0].week_update='5'                    
uci set passwall.@global_rules[0].time_update='4'                    
uci set passwall.@global_app[0]=global_app                           
uci set passwall.@auto_switch[0]=auto_switch                         
uci set passwall.@auto_switch[0].enable='0'                          
uci set passwall.@auto_switch[0].testing_time='1'                    
uci set passwall.@auto_switch[0].connect_timeout='3'                 
uci set passwall.@auto_switch[0].retry_num='3'                       
uci set passwall.@auto_switch[0].shunt_logic='1'                     
uci set passwall.f58512f7cb784412a7ad5f7679022cc7=nodes              
uci set passwall.f58512f7cb784412a7ad5f7679022cc7.tls='1'            
uci set passwall.f58512f7cb784412a7ad5f7679022cc7.protocol='trojan'  
uci set passwall.f58512f7cb784412a7ad5f7679022cc7.grpc_initial_windows_size='0'
uci set passwall.f58512f7cb784412a7ad5f7679022cc7.port='443'         
uci set passwall.f58512f7cb784412a7ad5f7679022cc7.alpn='h2'          
uci set passwall.f58512f7cb784412a7ad5f7679022cc7.fingerprint='disable'
uci set passwall.f58512f7cb784412a7ad5f7679022cc7.grpc_mode='gun'    
uci set passwall.f58512f7cb784412a7ad5f7679022cc7.type='Xray'        
uci set passwall.f58512f7cb784412a7ad5f7679022cc7.xtls='0'           
uci set passwall.f58512f7cb784412a7ad5f7679022cc7.transport='grpc'   
uci set passwall.f58512f7cb784412a7ad5f7679022cc7.add_mode='1'       
uci set passwall.f58512f7cb784412a7ad5f7679022cc7.remarks='store.c2201.top'
uci set passwall.f58512f7cb784412a7ad5f7679022cc7.address='store.c2201.top'
uci set passwall.f58512f7cb784412a7ad5f7679022cc7.password='store-c2201-top-password'
uci set passwall.f58512f7cb784412a7ad5f7679022cc7.tls_serverName='store.c2201.top'
uci set passwall.f58512f7cb784412a7ad5f7679022cc7.grpc_serviceName='store-c2201-top-service-name'
uci set passwall.b609bb2b317f4d739b2407adb3eac6c9=nodes              
uci set passwall.b609bb2b317f4d739b2407adb3eac6c9.remarks='Hys-c2201.top'
uci set passwall.b609bb2b317f4d739b2407adb3eac6c9.type='Hysteria'    
uci set passwall.b609bb2b317f4d739b2407adb3eac6c9.address='c2201.top'
uci set passwall.b609bb2b317f4d739b2407adb3eac6c9.port='32230'       
uci set passwall.b609bb2b317f4d739b2407adb3eac6c9.hysteria_auth_type='string'
uci set passwall.b609bb2b317f4d739b2407adb3eac6c9.hysteria_alpn='h3' 
uci set passwall.b609bb2b317f4d739b2407adb3eac6c9.tls_serverName='c2201.top'
uci set passwall.b609bb2b317f4d739b2407adb3eac6c9.hysteria_up_mbps='33'
uci set passwall.b609bb2b317f4d739b2407adb3eac6c9.hysteria_down_mbps='33'
uci set passwall.b609bb2b317f4d739b2407adb3eac6c9.hysteria_auth_password='c2201-top-password'
uci set passwall.b609bb2b317f4d739b2407adb3eac6c9.tls_allowInsecure='1'
uci set passwall.b609bb2b317f4d739b2407adb3eac6c9.protocol='wechat-video'
uci set passwall.b609bb2b317f4d739b2407adb3eac6c9.hysteria_recv_window_conn='2097152'
uci set passwall.b609bb2b317f4d739b2407adb3eac6c9.hysteria_recv_window='524288'
uci set passwall.b609bb2b317f4d739b2407adb3eac6c9.hysteria_handshake_timeout='15'
uci set passwall.b609bb2b317f4d739b2407adb3eac6c9.hysteria_idle_timeout='30'
uci set passwall.b609bb2b317f4d739b2407adb3eac6c9.hysteria_disable_mtu_discovery='1'
uci set passwall.5aad9f34a17943de9badca96a5e37173=nodes
uci set passwall.5aad9f34a17943de9badca96a5e37173.type='Xray'        
uci set passwall.5aad9f34a17943de9badca96a5e37173.protocol='_balancing'
uci set passwall.5aad9f34a17943de9badca96a5e37173.balancing_node='b609bb2b317f4d739b2407adb3eac6c9' 'f58512f7cb784412a7ad5f7679022cc7'
uci set passwall.5aad9f34a17943de9badca96a5e37173.domainStrategy='IPOnDemand'
uci set passwall.5aad9f34a17943de9badca96a5e37173.domainMatcher='hybrid'
uci set passwall.5aad9f34a17943de9badca96a5e37173.remarks='main-node'

uci commit passwall

mv /usr/share/xray/geoip.dat /usr/share/v2ray/geoip.dat
mv /usr/share/xray/geosite.dat /usr/share/v2ray/geosite.dat
rm -rf /usr/share/xray

sed -i "s/fastpath\"/fastpath >\/dev\/null\"/g" /usr/lib/lua/luci/controller/turboacc.lua

uci set network.wireguard=interface
uci set network.wireguard.proto='wireguard'
uci set network.wireguard.private_key='store_privatekey'
uci set network.wireguard.listen_port='12345'
uci set network.wireguard.addresses='10.0.0.2/24'
uci add network wireguard_wireguard
uci set network.@wireguard_wireguard[0]=wireguard_wireguard
uci set network.@wireguard_wireguard[0].route_allowed_ips='1'
uci set network.@wireguard_wireguard[0].persistent_keepalive='25'
uci set network.@wireguard_wireguard[0].endpoint_host='home6.caijinbiao.cn'
uci set network.@wireguard_wireguard[0].endpoint_port='12345'
uci set network.@wireguard_wireguard[0].public_key='server_publickey'
uci set network.@wireguard_wireguard[0].allowed_ips='10.0.0.1/32'
uci commit network

uci add firewall zone
uci set firewall.@zone[3]=zone
uci set firewall.@zone[3].name='wireguard'
uci set firewall.@zone[3].input='ACCEPT'
uci set firewall.@zone[3].output='ACCEPT'
uci set firewall.@zone[3].network='wireguard'
uci set firewall.@zone[3].forward='ACCEPT'
uci add firewall forwarding
uci set firewall.@forwarding[0]=forwarding
uci set firewall.@forwarding[0].dest='docker'
uci set firewall.@forwarding[0].src='lan'
uci add firewall forwarding
uci set firewall.@forwarding[1]=forwarding
uci set firewall.@forwarding[1].dest='wan'
uci set firewall.@forwarding[1].src='lan'
uci add firewall forwarding
uci set firewall.@forwarding[2]=forwarding
uci set firewall.@forwarding[2].dest='docker'
uci set firewall.@forwarding[2].src='wireguard'
uci add firewall forwarding
uci set firewall.@forwarding[3]=forwarding
uci set firewall.@forwarding[3].dest='lan'
uci set firewall.@forwarding[3].src='wireguard'
uci add firewall forwarding
uci set firewall.@forwarding[4]=forwarding
uci set firewall.@forwarding[4].dest='wan'
uci set firewall.@forwarding[4].src='wireguard'
uci add firewall forwarding
uci set firewall.@forwarding[5]=forwarding
uci set firewall.@forwarding[5].dest='wireguard'
uci set firewall.@forwarding[5].src='lan'

uci add firewall rule
uci set firewall.@rule[11]=rule
uci set firewall.@rule[11].target='ACCEPT'
uci set firewall.@rule[11].src='wan'
uci set firewall.@rule[11].proto='udp'
uci set firewall.@rule[11].dest_port='12345'
uci set firewall.@rule[11].name='Allow-Wireguard'
uci commit firewall

exit 0
